# Enable monorepo mode for subdirectory tasks
experimental_monorepo_root = true

[monorepo]
config_roots = ["js"]

[tools]
rust = "1.92"

[tools."github:bytecodealliance/wasm-tools"]
version = "1.236.1"

# =============================================================================
# Core development tasks
# =============================================================================

[tasks.check]
description = "Run cargo check"
run = "cargo check --workspace"

[tasks.build]
description = "Build all crates"
run = "cargo build --workspace"

[tasks.test]
description = "Run tests"
run = "cargo nextest run --workspace"

[tasks.lint]
description = "Run clippy lints"
run = "cargo clippy --workspace --all-targets -- -D warnings"

[tasks.lint-fix]
description = "Auto-fix clippy warnings"
run = "cargo clippy --fix --allow-dirty --workspace --all-targets"

[tasks.fmt]
description = "Format code"
run = "cargo fmt --all"

[tasks.fmt-check]
description = "Check code formatting"
run = "cargo fmt --all -- --check"

[tasks.ci]
description = "Run all CI checks"
depends = ["fmt-check", "lint", "test"]

[tasks.clean]
description = "Clean build artifacts"
run = "cargo clean"

# =============================================================================
# WASM shell build tasks
# =============================================================================

[tasks.wasm-target]
description = "Install wasm32-wasip2 target"
run = "rustup target add wasm32-wasip2"

[tasks.wasm-build]
description = "Build WASM shell component (wasip2)"
depends = ["wasm-target"]
sources = ["crates/conch-shell/src/**/*.rs", "crates/conch-shell/Cargo.toml", "crates/conch-shell/wit/**/*.wit"]
outputs = ["target/wasm32-wasip2/release/conch_shell.wasm"]
run = "cargo build -p conch-shell --target wasm32-wasip2 --release"

[tasks.wasm-build-small]
description = "Build WASM shell component (wasip2, size-optimized for JS bindings)"
depends = ["wasm-target"]
sources = ["crates/conch-shell/src/**/*.rs", "crates/conch-shell/Cargo.toml", "crates/conch-shell/wit/**/*.wit"]
outputs = ["target/wasm32-wasip2/release-wasm/conch_shell.wasm"]
run = "cargo build -p conch-shell --target wasm32-wasip2 --profile release-wasm"

[tasks.build-embedded]
description = "Build library with embedded WASM shell"
depends = ["wasm-build"]
run = "cargo build -p conch --features embedded-shell --release"

[tasks.build-release]
description = "Build all crates in release mode (with embedded shell)"
depends = ["wasm-build"]
run = "cargo build --workspace --features embedded-shell --release"

# =============================================================================
# Test tasks
# =============================================================================

[tasks.test-go]
description = "Run Go FFI tests"
depends = ["build-embedded"]
dir = "tests/go"
run = "go test -v ./..."

[tasks.test-all]
description = "Run all tests (Rust + Go)"
depends = ["test", "test-go"]

# =============================================================================
# MCP server tasks
# =============================================================================

[tasks.build-mcp]
description = "Build the MCP server binary"
depends = ["wasm-build"]
run = "cargo build -p conch-mcp --features conch/embedded-shell --release"

[tasks.run-mcp]
description = "Run the MCP server (stdio transport)"
depends = ["build-mcp"]
run = "./target/release/conch-mcp"

# =============================================================================
# Documentation
# =============================================================================

[tasks.doc]
description = "Generate documentation"
run = "cargo doc --workspace --no-deps"

[tasks.doc-open]
description = "Generate and open documentation"
run = "cargo doc --workspace --no-deps --open"

# =============================================================================
# Maintenance
# =============================================================================

[tasks.msrv]
description = "Check compilation on minimum supported Rust version"
run = "cargo +1.90 check --workspace"
