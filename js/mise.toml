[tools]
node = "24"

# =============================================================================
# JavaScript bindings tasks (browser/Node.js via jco)
# =============================================================================

[tasks.deps]
description = "Install JavaScript tooling dependencies"
run = "npm install -g @bytecodealliance/jco"

[tasks.transpile]
description = "Transpile WASM component to JavaScript using jco"
depends = ["//:wasm-build"]
sources = ["../target/wasm32-wasip2/release/conch_shell.wasm"]
outputs = ["conch-shell/conch-shell.js", "conch-shell/conch-shell.core.wasm"]
run = """
jco transpile \
  ../target/wasm32-wasip2/release/conch_shell.wasm \
  --name conch-shell \
  --optimize \
  --out-dir conch-shell \
  --map invoke-tool=./tool-handler.js \
  --map wasi:cli/*=./shims/cli.js#* \
  --map wasi:clocks/*=./shims/clocks.js#* \
  --map wasi:filesystem/*=./shims/filesystem.js#* \
  --map wasi:io/*=./shims/io.js#* \
  --map wasi:random/*=./shims/random.js#*
jco types \
  --name conch-shell \
  --out-dir conch-shell \
  ../crates/conch-shell/wit/shell.wit
"""

[tasks.build]
description = "Build JavaScript bindings (WASM + transpile + version sync)"
depends = ["transpile"]
sources = ["conch-shell/conch-shell.js", "../Cargo.toml"]
outputs = ["conch-shell/package.json"]
run = """
#!/usr/bin/env bash
set -euo pipefail
VERSION=$(cargo metadata --format-version 1 --manifest-path ../Cargo.toml | jq -r '.packages[] | select(.name == "conch-shell") | .version')
jq --arg v "$VERSION" '.version = $v' conch-shell/package.json > conch-shell/package.json.tmp
mv conch-shell/package.json.tmp conch-shell/package.json
"""

[tasks.test]
description = "Run JavaScript tests"
depends = ["build"]
sources = ["conch-shell/**/*.js", "conch-shell/**/*.wasm", "testpkg/**/*.ts"]
dir = "testpkg"
run = "npm ci && npm run typecheck && npm run test:ci"

[tasks.clean]
description = "Clean JavaScript build artifacts"
dir = "conch-shell"
run = "rm -rf *.wasm *.js *.d.ts interfaces"

[tasks.publish]
description = "Publish JavaScript package to npm"
depends = ["test"]
dir = "conch-shell"
run = "npm publish --access public"
