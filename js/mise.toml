[tools]
node = "24"
"npm:@bytecodealliance/jco" = "latest"

# =============================================================================
# JavaScript bindings tasks (browser/Node.js via jco)
# =============================================================================

[tasks.wasm-build-small]
description = "Build WASM shell component (wasip2, size-optimized for JS)"
sources = ["../crates/conch-shell/src/**/*.rs", "../crates/conch-shell/Cargo.toml", "../crates/conch-shell/wit/**/*.wit"]
outputs = ["../target/wasm32-wasip2/release-wasm/conch_shell.wasm"]
run = """
rustup target add wasm32-wasip2
cargo build -p conch-shell --target wasm32-wasip2 --profile release-wasm
"""

[tasks.transpile]
description = "Transpile WASM component to JavaScript using jco"
depends = ["wasm-build-small"]
sources = ["../target/wasm32-wasip2/release-wasm/conch_shell.wasm"]
outputs = ["conch-shell/conch-shell.js", "conch-shell/conch-shell.core.wasm"]
run = """
jco transpile \
  ../target/wasm32-wasip2/release-wasm/conch_shell.wasm \
  --name conch-shell \
  --optimize \
  --out-dir conch-shell \
  --map 'conch:shell/tools=./tool-handler.js' \
  --map wasi:cli/*=./shims/cli.js#* \
  --map wasi:clocks/*=./shims/clocks.js#* \
  --map wasi:filesystem/*=./shims/filesystem.js#* \
  --map wasi:io/*=./shims/io.js#* \
  --map wasi:random/*=./shims/random.js#* \
  -- --all-features
jco types \
  --name conch-shell \
  --out-dir conch-shell \
  ../crates/conch-shell/wit/shell.wit
"""

[tasks.patch-js]
description = "Patch generated JS for webpack compatibility (node:fs/promises)"
depends = ["transpile"]
sources = ["conch-shell/conch-shell.js"]
outputs = ["conch-shell/conch-shell.js"]
run = """
#!/usr/bin/env node
const fs = require('fs');
const path = 'conch-shell/conch-shell.js';
let code = fs.readFileSync(path, 'utf8');

// Patch the fetchCompile function for webpack compatibility
// Original: _fs = _fs || await import('node:fs/promises');
// Patched: wraps in try-catch and adds webpackIgnore comment
const original = `  if (isNode) {
    _fs = _fs || await import('node:fs/promises');
    return WebAssembly.compile(await _fs.readFile(url));
  }`;

const patched = `  if (isNode) {
    if (!_fs) {
      try {
        _fs = await import(/* webpackIgnore: true */ 'node:fs/promises');
      } catch {
        // Fallback for environments where node:fs/promises is unavailable
      }
    }
    if (_fs) {
      return WebAssembly.compile(await _fs.readFile(url));
    }
  }`;

if (code.includes(original)) {
  code = code.replace(original, patched);
  fs.writeFileSync(path, code);
  console.log('Patched conch-shell.js for webpack compatibility');
} else if (code.includes('webpackIgnore')) {
  console.log('conch-shell.js already patched');
} else {
  console.error('Warning: Could not find expected pattern in conch-shell.js');
  process.exit(1);
}
"""

[tasks.build]
description = "Build JavaScript bindings (WASM + transpile + version sync)"
depends = ["patch-js"]
sources = ["conch-shell/conch-shell.js", "../Cargo.toml"]
outputs = ["conch-shell/package.json"]
run = """
#!/usr/bin/env bash
set -euo pipefail
VERSION=$(cargo metadata --format-version 1 --manifest-path ../Cargo.toml | jq -r '.packages[] | select(.name == "conch-shell") | .version')
jq --arg v "$VERSION" '.version = $v' conch-shell/package.json > conch-shell/package.json.tmp
mv conch-shell/package.json.tmp conch-shell/package.json
"""

[tasks.test]
description = "Run JavaScript tests"
depends = ["build"]
sources = ["conch-shell/**/*.js", "conch-shell/**/*.wasm", "testpkg/**/*.ts"]
dir = "testpkg"
run = """
cd ../conch-shell && npm ci
cd ../testpkg && npm ci && npm run typecheck && npm run test:ci
"""

[tasks.clean]
description = "Clean JavaScript build artifacts (generated files only)"
dir = "conch-shell"
run = "rm -rf conch-shell.js conch-shell.d.ts conch-shell.core*.wasm interfaces"

[tasks.publish]
description = "Publish JavaScript package to npm"
depends = ["test"]
dir = "conch-shell"
run = "npm publish --access public"
