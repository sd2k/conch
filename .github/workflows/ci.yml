name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  MISE_EXPERIMENTAL: 1
  RUST_BACKTRACE: 1

jobs:
  # Build conch-shell WASM component - other jobs depend on this
  build-wasm:
    name: Build WASM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Configure Rust cache
        uses: Swatinem/rust-cache@v2

      - uses: ./.github/actions/setup-rust

      - name: Force rebuild (cache may have stale timestamps)
        run: |
          # Touch ALL sources to ensure mise doesn't skip build due to cached timestamps
          # The Rust cache may restore .wasm files with newer timestamps than sources
          find crates/conch-shell/src -name "*.rs" -exec touch {} +
          touch crates/conch-shell/Cargo.toml
          # Remove outputs (mise checks mtime, not existence)
          rm -f target/wasm32-wasip2/release/conch_shell.wasm

      - name: Build WASM component
        run: mise run wasm-build

      - name: Upload WASM artifact
        uses: actions/upload-artifact@v4
        with:
          name: wasm-shell
          path: target/wasm32-wasip2/release/conch_shell.wasm
          retention-days: 1

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: build-wasm
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Configure Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Download WASM artifact
        uses: actions/download-artifact@v4
        with:
          name: wasm-shell
          path: target/wasm32-wasip2/release/

      - uses: ./.github/actions/mark-wasm-current

      - uses: ./.github/actions/setup-rust

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build-wasm
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Configure Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Download WASM artifact
        uses: actions/download-artifact@v4
        with:
          name: wasm-shell
          path: target/wasm32-wasip2/release/

      - uses: ./.github/actions/mark-wasm-current

      - uses: ./.github/actions/setup-rust

      - name: Run tests
        # Exclude conch-grpc tests which have timing issues in CI
        run: cargo nextest run --workspace --all-features --exclude conch-grpc

  msrv:
    name: MSRV
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Configure Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install mise
        uses: jdx/mise-action@v3
        with:
          mise_toml: |
            [tools]
            rust = "1.90"

      - name: Check MSRV
        # Only check conch core without embedded-shell feature
        # Other crates require embedded-shell which needs the WASM artifact
        run: cargo check -p conch --no-default-features

  doc:
    name: Documentation
    runs-on: ubuntu-latest
    needs: build-wasm
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Configure Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Download WASM artifact
        uses: actions/download-artifact@v4
        with:
          name: wasm-shell
          path: target/wasm32-wasip2/release/

      - uses: ./.github/actions/mark-wasm-current

      - uses: ./.github/actions/setup-rust

      - name: Build documentation
        run: cargo doc --workspace --no-deps --all-features
        env:
          RUSTDOCFLAGS: -D warnings

  # Run examples to ensure they don't bitrot
  examples:
    name: Examples
    runs-on: ubuntu-latest
    needs: build-wasm
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Configure Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Download WASM artifact
        uses: actions/download-artifact@v4
        with:
          name: wasm-shell
          path: target/wasm32-wasip2/release/

      - uses: ./.github/actions/mark-wasm-current

      - uses: ./.github/actions/setup-rust

      - name: Run examples
        run: |
          echo "=== basic ==="
          cargo run --package conch --example basic --features embedded-shell --release
          echo "=== vfs_mounts ==="
          cargo run --package conch --example vfs_mounts --features embedded-shell --release
          echo "=== low_level ==="
          cargo run --package conch --example low_level --features embedded-shell --release
          echo "=== custom_storage ==="
          cargo run --package conch --example custom_storage --features embedded-shell --release
          echo "=== agent_sandbox ==="
          cargo run --package conch --example agent_sandbox --features embedded-shell --release
          echo "=== tool_execution ==="
          cargo run --package conch --example tool_execution --features embedded-shell --release
          echo "=== external_tools ==="
          cargo run --package conch --example external_tools --features embedded-shell --release
          echo "=== approval_and_policy ==="
          cargo run --package conch --example approval_and_policy --features embedded-shell --release
          echo "=== policy_enforcement ==="
          cargo run --package conch --example policy_enforcement --features embedded-shell --release

  # Test Go FFI bindings
  go-bindings:
    name: Go Bindings
    runs-on: ubuntu-latest
    needs: build-wasm
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Configure Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Download WASM artifact
        uses: actions/download-artifact@v4
        with:
          name: wasm-shell
          path: target/wasm32-wasip2/release/

      - uses: ./.github/actions/mark-wasm-current

      - uses: ./.github/actions/setup-rust

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Build library with embedded shell
        run: mise run build-embedded

      - name: Run Go tests
        working-directory: tests/go
        run: go test -v ./...
